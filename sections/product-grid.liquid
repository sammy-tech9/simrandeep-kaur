{% schema %}
{
    "name": "Featured Product Grid",
    "settings":[
        {
            "type": "text",
            "id": "grid_heading",
            "label": "Grid section heading",
            "default": "Tisso vison in the wild"
        },
        {
            "type": "product",
            "id": "product_1",
            "label": "product 1"
        },
        {
            "type": "product",
            "id": "product_2",
            "label": "product 2"
        },
        {
            "type": "product",
            "id": "product_3",
            "label": "product 3"
        },
        {
            "type": "product",
            "id": "product_4",
            "label": "product 4"
        },
        {
            "type": "product",
            "id": "product_5",
            "label": "product 5"
        },
        {
            "type": "product",
            "id": "product_6",
            "label": "product 6"
        }
    ],
    "presets": [
        {
            "name":"Featured Product Grid",
            "category": "Products"
        }
    ]
}
{% endschema %}

<section class="product-grid-section">
    <h2>{{ section.settings.grid_heading }}</h2>
    <div class="product-grid_container">

        {% assign products_list = section.settings.product_1 | append: ',' | append: section.settings.product_2 | append: ',' | append: section.settings.product_3 | append: ',' |
        append: section.settings.product_4 | append: ',' | append: section.settings.product_5 | append: ',' | append: section.settings.product_6 %}
        {% assign products_list = products_list | split: ',' %}

        {% for product_handle in products_list %}
            {% assign product_obj = all_products[product_handle] %}
            {% if product_obj %}
                <div class="product-grid_item" data-product-handle="{{ product_obj.handle }}">
                        {% if product_obj.featured_image %}
  {{
    product_obj.featured_image
    | image_url: width: 600
    | image_tag:
      alt: product_obj.title,
      loading: 'lazy',
      width: 433,
      height: 444
  }}
{% endif %}
                    {% comment %} <img src="{{ product_obj.featured_image | image_url: 'medium'}}" alt="{{ product_obj.title }}" height="444px" width="433px"> {% endcomment %}
                    <div class="btn">
                        <button 
                            class="product-grid_info-btn" 
                            data-handle="{{ product_obj.handle }}"
                            aria-label="View product">+</button>
                        
                    </div>
                </div>
                {% endif %}
                {% endfor %}
    </div>
    </section>

<div id="product-modal" class="product-modal hidden">
  <div class="product-modal_overlay"></div>

  <div class="product-modal_content">
    <button class="product-modal_close">&times;</button>

    <div class="product-modal_body">

      <img id="modal-image" src="" alt="" height="auto" width="auto">

      <div class="product-modal_info">

        <h3 id="modal-title"></h3>
        <p id="modal-price"></p>

        <p id="modal-description"></p>

        <!-- Variants -->
        <div id="modal-variants"></div>

        <button id="modal-add-btn">
          ADD TO CART →
        </button>

      </div>

    </div>
  </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {

  const modal = document.getElementById("product-modal");
  const closeBtn = document.querySelector(".product-modal_close");

  let currentProduct = null;
  let selectedVariant = null;

  /* Open Modal */
  document.querySelectorAll(".product-grid_info-btn").forEach(btn => {

    btn.addEventListener("click", async (e) => {

      const handle = btn.dataset.handle;

      const res = await fetch(`/products/${handle}.js`);
      const product = await res.json();

      currentProduct = product;

      openModal(product);
    });

  });


  /* Close Modal */
  closeBtn.addEventListener("click", closeModal);

  modal.querySelector(".product-modal_overlay")
    .addEventListener("click", closeModal);


  function closeModal() {
    modal.classList.add("hidden");
  }


  /* Build Modal */
  function openModal(product) {

    document.getElementById("modal-image").src =
      product.featured_image;

    document.getElementById("modal-title").textContent =
      product.title;

    document.getElementById("modal-price").textContent =
      `₹${(product.price / 100).toFixed(2)}`;

    document.getElementById("modal-description").innerHTML =
      product.description;

    buildVariants(product);

    modal.classList.remove("hidden");
  }


  /* Build Variant Selects */
  function buildVariants(product) {

    const container = document.getElementById("modal-variants");

    container.innerHTML = "";

    product.options.forEach((option, index) => {

      const group = document.createElement("div");
      group.className = "variant-group";

      const label = document.createElement("label");
      label.textContent = option;

      const select = document.createElement("select");

      product.variants.forEach(variant => {

        const value = variant.options[index];

        if (![...select.options].some(o => o.value === value)) {

          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = value;

          select.appendChild(opt);
        }

      });

      select.addEventListener("change", findVariant);

      group.append(label, select);

      container.appendChild(group);

    });

    findVariant();
  }


  /* Find Selected Variant */
  function findVariant() {

    const selects =
      document.querySelectorAll("#modal-variants select");

    const selected = [...selects].map(s => s.value);

    selectedVariant = currentProduct.variants.find(v => {

      return v.options.every(
        (opt, i) => opt === selected[i]
      );

    });

  }


  /* Add To Cart */
  document
    .getElementById("modal-add-btn")
    .addEventListener("click", async () => {

      if (!selectedVariant) return;

      await addToCart(selectedVariant.id, 1);

      /* Special Rule */
      autoAddSoftJacket();

      closeModal();
    });


  /* Add Item */
  async function addToCart(id, qty) {

    await fetch("/cart/add.js", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        id: id,
        quantity: qty
      })
    });

  }


  /* Rule: Auto Add Jacket */
  async function autoAddSoftJacket() {

    const v = selectedVariant;

    if (!v) return;

    const hasBlack =
      v.options.includes("Black");

    const hasMedium =
      v.options.includes("Medium");


    if (hasBlack && hasMedium) {

      const res = await fetch("/products/soft-winter-jacket.js");
      const jacket = await res.json();

      const firstVariant = jacket.variants[0];

      await addToCart(firstVariant.id, 1);

    }

  }

});
</script>